<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€é—†å¾Œå° | è¨‚å–®ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .container { margin-top: 30px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 95%; }
        h1 { color: #333; border-bottom: 2px solid #d4af37; padding-bottom: 10px; margin-bottom: 30px; }
        
        /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
        .table th { white-space: nowrap; }
        .item-row { margin-bottom: 4px; font-size: 0.95rem; }
        .qty-badge { color: #d4af37; font-weight: bold; margin-left: 5px; }
        
        /* ç‹€æ…‹æ¨™ç±¤é¡è‰² */
        .badge-new { background-color: #ffc107; color: #000; } /* æ–°è¨‚å–® */
        .badge-paid { background-color: #198754; color: #fff; } /* å·²ä»˜æ¬¾ */
        .badge-shipped { background-color: #0d6efd; color: #fff; } /* å·²å‡ºè²¨ */
        .badge-cancelled { background-color: #6c757d; color: #fff; } /* å·²å–æ¶ˆ */

        /* é¡§å®¢è³‡æ–™å€å¡Š */
        .customer-info { font-size: 0.9rem; line-height: 1.4; color: #555; }
        .customer-name { font-weight: bold; font-size: 1rem; color: #333; }
        .addr-text { display: block; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: help;}

        /* ä»˜æ¬¾æ–¹å¼ */
        .pay-method { font-weight: bold; display: block; margin-bottom: 5px; }
        .pay-transfer { color: #d63384; }
        .pay-cash { color: #0d6efd; }
        .total-price { font-size: 1.1rem; color: #c0392b; font-weight: bold; }

        .loading { text-align: center; padding: 50px; font-size: 1.2rem; color: #666; }
    </style>
</head>
<body>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>ğŸ“¦ è¨‚å–®ç®¡ç†å¾Œå°</h1>
            <button class="btn btn-outline-primary" onclick="window.location.reload()">
                <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th width="10%">è¨‚å–®è³‡è¨Š</th>
                        <th width="20%">é¡§å®¢è³‡æ–™</th>
                        <th width="30%">è³¼è²·å•†å“</th>
                        <th width="15%">é‡‘é¡èˆ‡ä»˜æ¬¾</th>
                        <th width="10%">ç›®å‰ç‹€æ…‹</th>
                        <th width="15%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="orderList">
                    <tr><td colspan="6" class="loading">æ­£åœ¨è®€å–è³‡æ–™åº«...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        // 1. å¼•å…¥ Firebase (æ–°å¢ doc, updateDoc)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, orderBy, query, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBvIuEg3C4Fc_z28qZd88WUrSPobVRFm2c",
            authDomain: "saeko-stone-shop.firebaseapp.com",
            projectId: "saeko-stone-shop",
            storageBucket: "saeko-stone-shop.firebasestorage.app",
            messagingSenderId: "1003229346534",
            appId: "1:1003229346534:web:03840c5aded73e1d71d927",
            measurementId: "G-9STDRJFN8H"
        };

        // 3. åˆå§‹åŒ–
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 4. è®€å–è¨‚å–®çš„åŠŸèƒ½ (å«è‡ªå‹•å–æ¶ˆéæœŸè¨‚å–®é‚è¼¯)
        async function fetchOrders() {
            const orderList = document.getElementById('orderList');
            const now = new Date(); // å–å¾—ç¾åœ¨æ™‚é–“
            
            try {
                const q = query(collection(db, "orders"), orderBy("orderTime", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    orderList.innerHTML = '<tr><td colspan="6" class="text-center p-5">ç›®å‰é‚„æ²’æœ‰ä»»ä½•è¨‚å–®å–”ï¼</td></tr>';
                    return;
                }

                let html = '';

                // ä½¿ç”¨ for...of è¿´åœˆä¾†æ”¯æ´ await æ“ä½œ
                for (const docSnapshot of querySnapshot.docs) {
                    let data = docSnapshot.data();
                    const orderId = docSnapshot.id;
                    
                    // --- â˜…â˜…â˜… è‡ªå‹•å–æ¶ˆé‚è¼¯é–‹å§‹ â˜…â˜…â˜… ---
                    let dateStr = "æ™‚é–“æœªå®š";
                    if (data.orderTime) {
                        const orderDate = data.orderTime.toDate();
                        dateStr = orderDate.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit' });

                        // è¨ˆç®—æ™‚é–“å·® (æ¯«ç§’)
                        const diffTime = now - orderDate;
                        const diffDays = diffTime / (1000 * 60 * 60 * 24); // æ›ç®—æˆå¤©æ•¸

                        // åˆ¤æ–·ï¼šå¦‚æœæ˜¯ã€Œæ–°è¨‚å–®ã€ä¸”ã€Œè¶…é 7 å¤©ã€
                        if (data.status === 'new' && diffDays > 7) {
                            console.log(`è¨‚å–® ${orderId} å·²éæœŸï¼Œè‡ªå‹•å–æ¶ˆ`);
                            // 1. æ›´æ–°è³‡æ–™åº«
                            await updateDoc(doc(db, "orders", orderId), { status: 'cancelled' });
                            // 2. æ›´æ–°ç›®å‰é¡¯ç¤ºçš„è³‡æ–™ç‹€æ…‹ï¼Œè®“ç•«é¢ä¸ç”¨é‡æ•´å°±é¡¯ç¤ºå–æ¶ˆ
                            data.status = 'cancelled'; 
                        }
                    }
                    // --- â˜…â˜…â˜… è‡ªå‹•å–æ¶ˆé‚è¼¯çµæŸ â˜…â˜…â˜… ---

                    // 2. è™•ç†é¡§å®¢è³‡æ–™
                    const contact = data.contactInfo || { name: 'èˆŠè¨‚å–®ç„¡è³‡æ–™', phone: '', address: '' };
                    
                    // 3. è™•ç†å•†å“å…§å®¹
                    let itemsHtml = '';
                    if (data.items && Array.isArray(data.items)) {
                        data.items.forEach(item => {
                            let quantity = item.qty ? item.qty : 1;
                            itemsHtml += `<div class="item-row">â€¢ ${item.title} <span class="qty-badge">x${quantity}</span></div>`;
                        });
                    }

                    // 4. è™•ç†ä»˜æ¬¾æ–¹å¼é¡¯ç¤º
                    let payMethodHtml = '';
                    if (data.paymentMethod === 'transfer') {
                        payMethodHtml = '<span class="pay-method pay-transfer"><i class="fas fa-university"></i> éŠ€è¡Œè½‰å¸³</span>';
                    } else {
                        payMethodHtml = '<span class="pay-method pay-cash"><i class="fas fa-store"></i> åº—å…§ä»˜ç¾</span>';
                    }

                    // 5. è™•ç†ç‹€æ…‹èˆ‡æŒ‰éˆ•é‚è¼¯
                    let statusBadge = '';
                    let actionButtons = '';

                    if (data.status === 'new') {
                        statusBadge = '<span class="badge badge-new">å¾…è™•ç†</span>';
                        actionButtons = `<button class="btn btn-success btn-sm w-100 mb-1" onclick="window.updateStatus('${orderId}', 'paid')">ç¢ºèªå·²æ”¶æ¬¾</button>`;
                    } else if (data.status === 'paid') {
                        statusBadge = '<span class="badge badge-paid">å·²æ”¶æ¬¾</span>';
                        actionButtons = `<button class="btn btn-primary btn-sm w-100 mb-1" onclick="window.updateStatus('${orderId}', 'shipped')">é€šçŸ¥å·²å‡ºè²¨/å–è²¨</button>`;
                    } else if (data.status === 'shipped') {
                        statusBadge = '<span class="badge badge-shipped">å·²å‡ºè²¨</span>';
                        actionButtons = '<span class="text-success"><i class="fas fa-check"></i> å®Œæˆ</span>';
                    } else if (data.status === 'cancelled') {
                        statusBadge = '<span class="badge badge-cancelled">å·²å–æ¶ˆ (éæœŸ/æ‰‹å‹•)</span>';
                        actionButtons = '<span class="text-muted">ç„¡æ“ä½œ</span>';
                    }

                    if (data.status !== 'cancelled' && data.status !== 'shipped') {
                        actionButtons += `<button class="btn btn-outline-danger btn-sm w-100" onclick="window.updateStatus('${orderId}', 'cancelled')">å–æ¶ˆè¨‚å–®</button>`;
                    }

                    html += `
                        <tr>
                            <td>
                                <small class="text-muted d-block">${dateStr}</small>
                                <small class="text-primary d-block" title="${orderId}">#${orderId.slice(0,6)}</small>
                            </td>
                            <td>
                                <div class="customer-info">
                                    <div class="customer-name">${contact.name}</div>
                                    <div>${contact.phone}</div>
                                    <div class="addr-text" title="${contact.address}">${contact.address}</div>
                                </div>
                            </td>
                            <td>${itemsHtml}</td>
                            <td>
                                ${payMethodHtml}
                                <div class="total-price">NT$ ${data.totalPrice.toLocaleString()}</div>
                            </td>
                            <td class="text-center">${statusBadge}</td>
                            <td>${actionButtons}</td>
                        </tr>
                    `;
                }

                orderList.innerHTML = html;

            } catch (error) {
                console.error("è®€å–å¤±æ•—:", error);
                orderList.innerHTML = `<tr><td colspan="6" class="text-center text-danger p-5">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console éŒ¯èª¤è¨Šæ¯ã€‚<br>${error.message}</td></tr>`;
            }
        }

        // 5. æ›´æ–°è¨‚å–®ç‹€æ…‹çš„åŠŸèƒ½ (ç¶å®šåˆ° window è®“ HTML å‘¼å«)
        window.updateStatus = async (orderId, newStatus) => {
            let confirmText = '';
            let confirmBtnColor = '#3085d6';

            if (newStatus === 'paid') confirmText = 'ç¢ºèªå·²ç¶“æ”¶åˆ°æ¬¾é …äº†å—ï¼Ÿ';
            if (newStatus === 'shipped') confirmText = 'ç¢ºèªé€šçŸ¥å®¢äººå–è²¨/å‡ºè²¨å—ï¼Ÿ';
            if (newStatus === 'cancelled') {
                confirmText = 'ç¢ºå®šè¦å–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ(ç„¡æ³•å¾©åŸ)';
                confirmBtnColor = '#d33';
            }

            const result = await Swal.fire({
                title: 'ç¢ºèªæ“ä½œ',
                text: confirmText,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: confirmBtnColor,
                cancelButtonText: 'å†æƒ³æƒ³',
                confirmButtonText: 'æ˜¯çš„ï¼ŒåŸ·è¡Œ'
            });

            if (result.isConfirmed) {
                try {
                    // å¯«å…¥è³‡æ–™åº«
                    const orderRef = doc(db, "orders", orderId);
                    await updateDoc(orderRef, { status: newStatus });
                    
                    Swal.fire('æˆåŠŸ', 'è¨‚å–®ç‹€æ…‹å·²æ›´æ–°', 'success');
                    fetchOrders(); // é‡æ–°æ•´ç†è¡¨æ ¼
                } catch (e) {
                    console.error(e);
                    Swal.fire('éŒ¯èª¤', 'æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'error');
                }
            }
        }

        // å•Ÿå‹•è®€å–
        fetchOrders();
    </script>
</body>
</html>